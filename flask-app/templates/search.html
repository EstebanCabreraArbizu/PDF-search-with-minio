<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda de Planillas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <!-- ========================================= -->
        <!-- PANTALLA DE LOGIN (visible al inicio)    -->
        <!-- ========================================= -->
        <div id="loginScreen">
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-center mb-4">üîí Iniciar Sesi√≥n</h3>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label">Usuario</label>
                                    <input type="text" class="form-control" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contrase√±a</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Ingresar</button>
                                <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- PANTALLA DE B√öSQUEDA (oculta al inicio)  -->
        <!-- ========================================= -->
        <div id="searchScreen" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üîç B√∫squeda de Planillas</h2>
                <div>
                    <span id="username" class="me-3"></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <form id="searchForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">C√≥digo Empleado</label>
                                <input type="text" class="form-control" name="codigo_empleado" 
                                       placeholder="Ej: 12345">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Banco</label>
                                <select class="form-select" name="banco">
                                    <option value="">Todos</option>
                                    <option>BBVA</option>
                                    <option>BCP</option>
                                    <option>INTERBANK</option>
                                    <option>SCOTIABANK</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Mes</label>
                                <select class="form-select" name="mes">
                                    <option value="">Todos</option>
                                    <option value="01">Enero</option>
                                    <option value="02">Febrero</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Mayo</option>
                                    <option value="06">Junio</option>
                                    <option value="07">Julio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Raz√≥n Social</label>
                                <select class="form-select" name="razon_social">
                                    <option value="">Todas</option>
                                    <option>RESGUARDO</option>
                                    <option>ALARMAS</option>
                                    <option>FACILITIES</option>
                                    <option>LIDERMAN SERVICIOS</option>
                                    <option>SELVA</option>
                                    <option>AZZARO</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <span id="searchBtn">Buscar</span>
                            <span id="loadingBtn" class="d-none">
                                <span class="spinner-border spinner-border-sm"></span> Buscando...
                            </span>
                        </button>
                    </form>
                </div>
            </div>
            
            <div id="resultsContainer" class="d-none">
                <div class="alert alert-info">
                    <strong id="totalResults"></strong>
                </div>
                <div id="results" class="row"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Token JWT almacenado en memoria (m√°s seguro que localStorage)
        let authToken = null;
        let currentUser = null;

        // ========================================
        // LOGIN
        // ========================================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const credentials = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(credentials)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    
                    // DEBUG: Verificar que el token se guard√≥
                    console.log('‚úì Token recibido:', authToken ? authToken.substring(0, 20) + '...' : 'NULL');
                    console.log('‚úì Usuario:', currentUser);
                    
                    // Mostrar pantalla de b√∫squeda
                    document.getElementById('loginScreen').classList.add('d-none');
                    document.getElementById('searchScreen').classList.remove('d-none');
                    document.getElementById('username').textContent = `üë§ ${currentUser.full_name || currentUser.username}`;
                } else {
                    document.getElementById('loginError').textContent = data.error;
                    document.getElementById('loginError').classList.remove('d-none');
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error);
            }
        });

        // ========================================
        // LOGOUT
        // ========================================
        function logout() {
            authToken = null;
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('searchScreen').classList.add('d-none');
            document.getElementById('loginForm').reset();
        }

        // ========================================
        // B√öSQUEDA
        // ========================================
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            document.getElementById('searchBtn').classList.add('d-none');
            document.getElementById('loadingBtn').classList.remove('d-none');
            
            const formData = new FormData(e.target);
            const filters = {};
            for (let [key, value] of formData.entries()) {
                if (value) filters[key] = value;
            }
            
            try {
                // DEBUG: Verificar que el token existe antes de enviar
                console.log('Enviando b√∫squeda con token:', authToken ? authToken.substring(0, 20) + '...' : 'NULL');
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`  // ‚Üê JWT incluido
                    },
                    body: JSON.stringify(filters)
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                if (response.status === 401) {
                    alert('Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.');
                    logout();
                    return;
                }
                
                const data = await response.json();
                
                // Manejar errores del servidor
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('resultsContainer').classList.add('d-none');
                } else {
                    displayResults(data);
                }
            } catch (error) {
                alert('Error en la b√∫squeda: ' + error);
                document.getElementById('resultsContainer').classList.add('d-none');
            } finally {
                document.getElementById('searchBtn').classList.remove('d-none');
                document.getElementById('loadingBtn').classList.add('d-none');
            }
        });
        
        function displayResults(data) {
            const container = document.getElementById('results');
            const totalEl = document.getElementById('totalResults');
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Validar que data tiene la estructura esperada
            if (!data || typeof data.total === 'undefined' || !Array.isArray(data.results)) {
                console.error('Datos inv√°lidos:', data);
                alert('Error: Respuesta del servidor inv√°lida');
                return;
            }
            
            totalEl.textContent = `Se encontraron ${data.total} documento(s)`;
            resultsContainer.classList.remove('d-none');
            
            if (data.total === 0) {
                container.innerHTML = '<p class="text-muted">No se encontraron resultados</p>';
                return;
            }
            
            container.innerHTML = data.results.map(r => `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${r.filename}</h6>
                            <p class="card-text small">
                                <strong>Banco:</strong> ${r.metadata.banco}<br>
                                <strong>Mes:</strong> ${r.metadata.mes}<br>
                                <strong>Raz√≥n Social:</strong> ${r.metadata.razon_social}<br>
                                <strong>Tama√±o:</strong> ${r.size_kb} KB
                            </p>
                            <button onclick="downloadFile('${r.download_url}')" class="btn btn-sm btn-primary">
                                üì• Descargar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // DESCARGA (con JWT)
        // ========================================
        async function downloadFile(url) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    alert('Sesi√≥n expirada');
                    logout();
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (error) {
                alert('Error descargando archivo: ' + error);
            }
        }
    </script>
</body>
</html>