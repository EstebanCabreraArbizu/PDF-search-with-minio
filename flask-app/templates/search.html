<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫squeda de Planillas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filter-badge {
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }
        .result-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        .metadata-item {
            display: inline-block;
            margin-right: 1rem;
            font-size: 0.875rem;
        }
        .metadata-label {
            font-weight: 600;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- ========================================= -->
        <!-- PANTALLA DE LOGIN (visible al inicio)    -->
        <!-- ========================================= -->
        <div id="loginScreen">
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-center mb-4">üîí Iniciar Sesi√≥n</h3>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label">Usuario</label>
                                    <input type="text" class="form-control" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contrase√±a</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Ingresar</button>
                                <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- PANTALLA DE B√öSQUEDA (oculta al inicio)  -->
        <!-- ========================================= -->
        <div id="searchScreen" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üîç B√∫squeda de Planillas</h2>
                <div>
                    <span id="username" class="me-3"></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <form id="searchForm">
                        <div class="row g-3">
                            <!-- C√≥digo de Empleado -->
                            <div class="col-md-2">
                                <label class="form-label">C√≥digo Empleado</label>
                                <input type="text" class="form-control" name="codigo_empleado" 
                                       placeholder="Ej: 12345" pattern="\d{4,10}"
                                       title="Debe contener entre 4 y 10 d√≠gitos">
                            </div>
                            
                            <!-- A√±o (NUEVO) -->
                            <div class="col-md-2">
                                <label class="form-label">A√±o üìÖ</label>
                                <select class="form-select" name="a√±o" id="selectA√±o">
                                    <option value="">Todos</option>
                                    <!-- Opciones cargadas din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Mes -->
                            <div class="col-md-2">
                                <label class="form-label">Mes</label>
                                <select class="form-select" name="mes" id="selectMes">
                                    <option value="">Todos</option>
                                    <!-- Opciones cargadas din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Banco -->
                            <div class="col-md-2">
                                <label class="form-label">Banco üè¶</label>
                                <select class="form-select" name="banco" id="selectBanco">
                                    <option value="">Todos</option>
                                    <!-- Opciones cargadas din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Raz√≥n Social -->
                            <div class="col-md-4">
                                <label class="form-label">Raz√≥n Social üè¢</label>
                                <select class="form-select" name="razon_social" id="selectRazonSocial">
                                    <option value="">Todas</option>
                                    <!-- Opciones cargadas din√°micamente -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <span id="searchBtn">üîç Buscar</span>
                                <span id="loadingBtn" class="d-none">
                                    <span class="spinner-border spinner-border-sm"></span> Buscando...
                                </span>
                            </button>
                            <button type="reset" class="btn btn-outline-secondary" onclick="clearFilters()">
                                üóëÔ∏è Limpiar Filtros
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Resultados -->
            <div id="resultsContainer" class="d-none">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <strong id="totalResults"></strong>
                    <span id="activeFilters" class="text-muted small"></span>
                </div>
                <div id="results" class="row"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Token JWT almacenado en memoria (m√°s seguro que localStorage)
        let authToken = null;
        let currentUser = null;
        let filterOptions = null;

        // ========================================
        // LOGIN
        // ========================================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const credentials = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(credentials)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    
                    console.log('‚úì Token recibido:', authToken ? authToken.substring(0, 20) + '...' : 'NULL');
                    console.log('‚úì Usuario:', currentUser);
                    
                    // Mostrar pantalla de b√∫squeda
                    document.getElementById('loginScreen').classList.add('d-none');
                    document.getElementById('searchScreen').classList.remove('d-none');
                    document.getElementById('username').textContent = `üë§ ${currentUser.full_name || currentUser.username}`;
                    
                    // Cargar opciones de filtros despu√©s del login
                    await loadFilterOptions();
                } else {
                    document.getElementById('loginError').textContent = data.error;
                    document.getElementById('loginError').classList.remove('d-none');
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error);
            }
        });

        // ========================================
        // CARGAR OPCIONES DE FILTROS
        // ========================================
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Error cargando opciones de filtros');
                    return;
                }
                
                filterOptions = await response.json();
                
                // Poblar selector de A√±os
                const selectA√±o = document.getElementById('selectA√±o');
                selectA√±o.innerHTML = '<option value="">Todos</option>';
                filterOptions.a√±os.forEach(a√±o => {
                    selectA√±o.innerHTML += `<option value="${a√±o}">${a√±o}</option>`;
                });
                
                // Poblar selector de Meses
                const selectMes = document.getElementById('selectMes');
                selectMes.innerHTML = '<option value="">Todos</option>';
                filterOptions.meses.forEach(mes => {
                    selectMes.innerHTML += `<option value="${mes.value}">${mes.label}</option>`;
                });
                
                // Poblar selector de Bancos
                const selectBanco = document.getElementById('selectBanco');
                selectBanco.innerHTML = '<option value="">Todos</option>';
                filterOptions.bancos.forEach(banco => {
                    selectBanco.innerHTML += `<option value="${banco}">${banco}</option>`;
                });
                
                // Poblar selector de Razones Sociales
                const selectRazonSocial = document.getElementById('selectRazonSocial');
                selectRazonSocial.innerHTML = '<option value="">Todas</option>';
                filterOptions.razones_sociales.forEach(rs => {
                    selectRazonSocial.innerHTML += `<option value="${rs}">${rs}</option>`;
                });
                
                console.log('‚úì Opciones de filtros cargadas');
            } catch (error) {
                console.error('Error cargando opciones:', error);
            }
        }

        // ========================================
        // LOGOUT
        // ========================================
        function logout() {
            authToken = null;
            currentUser = null;
            filterOptions = null;
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('searchScreen').classList.add('d-none');
            document.getElementById('loginForm').reset();
            document.getElementById('resultsContainer').classList.add('d-none');
        }

        // ========================================
        // LIMPIAR FILTROS
        // ========================================
        function clearFilters() {
            document.getElementById('searchForm').reset();
            document.getElementById('resultsContainer').classList.add('d-none');
        }

        // ========================================
        // B√öSQUEDA
        // ========================================
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            document.getElementById('searchBtn').classList.add('d-none');
            document.getElementById('loadingBtn').classList.remove('d-none');
            
            const formData = new FormData(e.target);
            const filters = {};
            const activeFiltersList = [];
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    filters[key] = value;
                    // Crear lista de filtros activos para mostrar
                    activeFiltersList.push(`${key}: ${value}`);
                }
            }
            
            try {
                console.log('Enviando b√∫squeda con filtros:', filters);
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(filters)
                });
                
                console.log('Respuesta del servidor:', response.status);
                
                if (response.status === 401) {
                    alert('Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.');
                    logout();
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('resultsContainer').classList.add('d-none');
                } else {
                    // Mostrar filtros activos
                    document.getElementById('activeFilters').textContent = 
                        activeFiltersList.length > 0 
                            ? `Filtros: ${activeFiltersList.join(' | ')}` 
                            : 'Sin filtros aplicados';
                    displayResults(data);
                }
            } catch (error) {
                alert('Error en la b√∫squeda: ' + error);
                document.getElementById('resultsContainer').classList.add('d-none');
            } finally {
                document.getElementById('searchBtn').classList.remove('d-none');
                document.getElementById('loadingBtn').classList.add('d-none');
            }
        });
        
        function displayResults(data) {
            const container = document.getElementById('results');
            const totalEl = document.getElementById('totalResults');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (!data || typeof data.total === 'undefined' || !Array.isArray(data.results)) {
                console.error('Datos inv√°lidos:', data);
                alert('Error: Respuesta del servidor inv√°lida');
                return;
            }
            
            totalEl.textContent = `üìÑ Se encontraron ${data.total} documento(s)`;
            resultsContainer.classList.remove('d-none');
            
            if (data.total === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted text-center">No se encontraron resultados con los filtros aplicados.</p></div>';
                return;
            }
            
            container.innerHTML = data.results.map(r => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card result-card h-100">
                        <div class="card-body">
                            <h6 class="card-title text-truncate" title="${r.filename}">
                                üìÑ ${r.filename.split('/').pop()}
                            </h6>
                            <div class="mb-2">
                                <span class="badge bg-primary">${r.metadata.a√±o || 'N/A'}</span>
                                <span class="badge bg-secondary">${r.metadata.mes ? getMesNombre(r.metadata.mes) : 'N/A'}</span>
                                <span class="badge bg-info text-dark">${r.metadata.banco}</span>
                            </div>
                            <p class="card-text small mb-2">
                                <span class="metadata-item">
                                    <span class="metadata-label">üè¢ Raz√≥n Social:</span> ${r.metadata.razon_social}
                                </span><br>
                                <span class="metadata-item">
                                    <span class="metadata-label">üìÅ Tipo:</span> ${r.metadata.tipo_documento}
                                </span><br>
                                <span class="metadata-item">
                                    <span class="metadata-label">üì¶ Tama√±o:</span> ${r.size_kb} KB
                                </span>
                            </p>
                            <small class="text-muted d-block mb-2" style="font-size: 0.7rem;">
                                ${r.filename}
                            </small>
                            <button onclick="downloadFile('${r.download_url}')" class="btn btn-sm btn-primary w-100">
                                üì• Descargar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Helper para obtener nombre del mes
        function getMesNombre(mesNum) {
            const meses = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            return meses[mesNum] || mesNum;
        }

        // ========================================
        // DESCARGA (con JWT)
        // ========================================
        async function downloadFile(url) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    alert('Sesi√≥n expirada');
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'No se pudo descargar el archivo'));
                    return;
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = url.split('/').pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                alert('Error descargando archivo: ' + error);
            }
        }
    </script>
</body>
</html>
