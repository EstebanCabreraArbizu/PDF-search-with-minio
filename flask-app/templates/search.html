<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B칰squeda de Planillas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">游댌 B칰squeda Inteligente de PDFs</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">C칩digo Empleado</label>
                            <input type="text" class="form-control" name="codigo_empleado" 
                                   placeholder="Ej: 12345">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Banco</label>
                            <select class="form-select" name="banco">
                                <option value="">Todos</option>
                                <option>BBVA</option>
                                <option>BCP</option>
                                <option>INTERBANK</option>
                                <option>SCOTIABANK</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mes</label>
                            <select class="form-select" name="mes">
                                <option value="">Todos</option>
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Raz칩n Social</label>
                            <select class="form-select" name="razon_social">
                                <option value="">Todas</option>
                                <option>RESGUARDO</option>
                                <option>ALARMAS</option>
                                <option>FACILITIES</option>
                                <option>LIDERMAN SERVICIOS</option>
                                <option>SELVA</option>
                                <option>AZZARO</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">
                        <span id="searchBtn">Buscar</span>
                        <span id="loadingBtn" class="d-none">
                            <span class="spinner-border spinner-border-sm"></span> Buscando...
                        </span>
                    </button>
                </form>
            </div>
        </div>
        
        <div id="resultsContainer" class="d-none">
            <div class="alert alert-info">
                <strong id="totalResults"></strong>
            </div>
            <div id="results" class="row"></div>
        </div>
    </div>
    
    <script>
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UI: Mostrar loading
            document.getElementById('searchBtn').classList.add('d-none');
            document.getElementById('loadingBtn').classList.remove('d-none');
            
            // Recolectar filtros
            const formData = new FormData(e.target);
            const filters = {};
            for (let [key, value] of formData.entries()) {
                if (value) filters[key] = value;
            }
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(filters)
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert('Error en la b칰squeda: ' + error);
            } finally {
                // UI: Ocultar loading
                document.getElementById('searchBtn').classList.remove('d-none');
                document.getElementById('loadingBtn').classList.add('d-none');
            }
        });
        
        function displayResults(data) {
            const container = document.getElementById('results');
            const totalEl = document.getElementById('totalResults');
            const resultsContainer = document.getElementById('resultsContainer');
            
            totalEl.textContent = `Se encontraron ${data.total} documento(s)`;
            resultsContainer.classList.remove('d-none');
            
            if (data.total === 0) {
                container.innerHTML = '<p class="text-muted">No se encontraron resultados</p>';
                return;
            }
            
            container.innerHTML = data.results.map(r => `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${r.filename}</h6>
                            <p class="card-text small">
                                <strong>Banco:</strong> ${r.metadata.banco}<br>
                                <strong>Mes:</strong> ${r.metadata.mes}<br>
                                <strong>Raz칩n Social:</strong> ${r.metadata.razon_social}<br>
                                <strong>Tama침o:</strong> ${r.size_kb} KB
                            </p>
                            <a href="${r.download_url}" class="btn btn-sm btn-primary" target="_blank">
                                游닌 Descargar
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>